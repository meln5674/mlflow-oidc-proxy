{{- $oauth2Proxy := index .Values "oauth2-proxy" }}
{{- $mlflowOIDCProxy := index .Values "mlflow-oidc-proxy" }}
{{- $mlflowOIDCProxyChart := (index .Subcharts "mlflow-oidc-proxy").Chart }}
{{- $mlflowOIDCProxyDot := set (set (deepCopy .) "Values" $mlflowOIDCProxy) "Chart" $mlflowOIDCProxyChart }}
{{- $upstreamHost := include "mlflow-oidc-proxy.fullname" $mlflowOIDCProxyDot }}
{{- $upstreamPort := $mlflowOIDCProxy.service.port }}
{{- $upstreamTLS := not (empty $mlflowOIDCProxy.config.yaml.tls.enabled) }}
{{- $upstreamProto := ternary "https" "http" $upstreamTLS }}
upstreams=[ "{{ $upstreamProto }}://{{ $upstreamHost }}:{{ $upstreamPort }}" ]
redirect_url="{{ include "mlflow-multitenant.externalURL" . }}/oauth2/callback"
provider="oidc"
provider_display_name="Keycloak"
oidc_issuer_url="https://{{ .Values.keycloak.ingress.hostname }}/realms/{{ .Values.keycloakJob.realm }}"
scope="profile roles profile email openid"
{{- range $oauth2Proxy.extraVolumeMounts }}
{{- if eq .name "provider-ca" }}
provider_ca_files=["{{ .mountPath }}"]
{{- end }}
{{- end }}
exchange_refresh_bearer_tokens=true
generated_token_type="refresh"
pass_access_token=true
email_domains=["*"]
